/*!
 * Copyright (c) 2015 Brian Chan (bchanx.com)
 * All Rights Reserved.
 */

var bchanx=bchanx||{};
(function(d,a){d.playlist=a()})(this,function(){var d={UNKNOWN:-1,YOUTUBE:0},a={getUrl:function(a,b){if(a)switch(b){case d.YOUTUBE:return"https://www.youtube.com/embed/"+a+"?rel=0&enablejsapi=1&iv_load_policy=3&showinfo=0&theme=light"}return null},id:function(a){return a.current?a.current.id:""},mediaId:function(a){return a.current?a.current.meta.mediaId:""},type:function(a){return a.current?a.current.meta.mediaType:""},url:function(c){return c.current&&a.getUrl(a.mediaId(c),a.type(c))||""},title:function(a){return a.current&&
a.current.meta.title||"UNKNOWN"},duration:function(a){return a.current&&a.current.meta.duration||"0"}},e={toggleShuffle:function(a){a.isShuffled=!a.isShuffled},toggleRepeat:function(a){a.isRepeat=!a.isRepeat},prev:function(c){var b=c.currentList();if(0<=b.indexOf(c.current)){var l=(b.indexOf(c.current)+b.length-1)%b.length;c.current=b[l]}return a.mediaId(c)},next:function(c){var b=c.currentList();if(0<=b.indexOf(c.current)){var l=(b.indexOf(c.current)+1)%b.length;c.current=b[l]}return a.mediaId(c)},
isEmpty:function(a){return!a.current},setCurrent:function(a,b){return b in a.idToVideo?(a.current=a.idToVideo[b],!0):!1}},m=function(c){var b={videos:c||[],idToVideo:function(a){for(var b=0,h={};b<a.length;b++)h[a[b].id]=a[b];return h}(c||[]),shuffledVideos:function(a){a=a.slice(0);for(var b=a.length-1;0<b;b--){var h=Math.floor(Math.random()*(b+1)),n=a[b];a[b]=a[h];a[h]=n}return a}(c),isShuffled:!0,isRepeat:!1,currentList:function(){return b.isShuffled?b.shuffledVideos:b.videos},current:null};b.current=
b.currentList()[0];return{videos:function(){return b.videos},shuffledVideos:function(){return b.shuffledVideos},prev:function(){return e.prev(b)},next:function(){return e.next(b)},toggleShuffle:function(){e.toggleShuffle(b);return this},toggleRepeat:function(){e.toggleRepeat(b);return this},setCurrent:function(a){return e.setCurrent(b,a)},isEmpty:function(){return e.isEmpty(b)},isShuffled:function(){return b.isShuffled},isRepeat:function(){return b.isRepeat},getMediaId:function(){return a.mediaId(b)},
getUrl:function(){return a.url(b)},getId:function(){return a.id(b)},getTitle:function(){return a.title(b)},getDuration:function(){return a.duration(b)}}};return{type:d,getUrl:a.getUrl,create:function(a){return new m(a)}}});bchanx.player={};function onYouTubeIframeAPIReady(){bchanx.player=new YT.Player("video-src",{events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange}})}function onPlayerReady(d){d.target.setVolume(100);d.target.playVideo()}
function onPlayerStateChange(d){d.data==YT.PlayerState.PLAYING?($("#play").hide(),$("#pause").css("display","inline-block")):d.data==YT.PlayerState.PAUSED?($("#pause").hide(),$("#play").css("display","inline-block")):d.data==YT.PlayerState.ENDED&&$("#next").trigger("click",[!0])}function googleApiClientReady(){gapi.client.setApiKey(bchanx.googleApiKey);gapi.client.load("youtube","v3")}
var Jukebox=function(){var d=null,a=null,e={},m={formatTime:function(a){return 0<a.indexOf(":")?a:Math.floor(a/60)+":"+("0"+a%60).slice(-2)},jq:function(a){return"#"+a.replace(/(:|\.|\[|\])/g,"\\$1")}},c={createTracklist:function(a,b){for(var g=$('<tbody class="'+b+'" style="display: none"></tbody>'),p=0;p<a.length;p++){var k=a[p],c=k.meta.title,d=m.formatTime(k.meta.duration);g.append('<tr mediaid="'+k.id+'" class="mediaItem"><td class="track" title="'+c+'">'+c+'</td><td class="length">'+d+"</td></tr>")}return g}},
b={static:function(){$("#pause").bind("click",function(){a&&!a.isEmpty()&&bchanx.player.hasOwnProperty("pauseVideo")&&bchanx.player.pauseVideo()});$("#play").bind("click",function(){a&&!a.isEmpty()&&bchanx.player.hasOwnProperty("playVideo")&&bchanx.player.playVideo()});$("#prev").bind("click",function(){a&&!a.isEmpty()&&bchanx.player.hasOwnProperty("loadVideoById")&&(bchanx.player.loadVideoById(a.prev()),f.updateNowPlaying())});$("#next").bind("click",function(b,c){a&&!a.isEmpty()&&(c&&a.isRepeat()?
bchanx.player.seekTo(0):bchanx.player.hasOwnProperty("loadVideoById")&&(bchanx.player.loadVideoById(a.next()),f.updateNowPlaying()))});$("#repeat").bind("click",function(){if(a&&!a.isEmpty()){a.toggleRepeat();var b=a.isRepeat();$("#repeat").removeClass(b?"off":"on").addClass(b?"on":"off")}});$("#shuffle").bind("click",function(){a&&!a.isEmpty()&&f.toggleShuffle()});$("#playlist").bind("click",function(){a&&!a.isEmpty()&&f.toggleTracklist()})},dynamic:function(){$(document).on("click",".mediaItem",
function(){a&&!a.isEmpty()&&a.setCurrent($(this).attr("mediaid"))&&(bchanx.player.loadVideoById(a.getMediaId()),f.updateNowPlaying())});$(document).on("click","li[pid]",function(){f.loadPlaylist($(this).attr("pid"))});$(document).keydown(function(a){"search-box"!==$(a.target).attr("id")&&(78===a.which?$("#next").click():80===a.which?$("#prev").click():83===a.which&&$("#shuffle").click())})}},l={onPlaylistGetAll:function(a){if(a.length){a=a.sort(function(a,g){return a.pid-g.pid});for(var b=$("<ul></ul>"),
g=0;g<a.length;g++)b.append('<li pid="'+a[g].pid+'">'+a[g].title+"</li>");$("#playlists").append(b)}d=slidr.create("jukebox",{transition:"cube",overflow:!0,controls:"none",keyboard:!0}).add("h",["playlists","video","about","playlists"]).add("v",["playlists","video","about","playlists"]).start();$("#search-container").fadeIn(400);setInterval(function(){var a=$("#jukebox-container").hasClass("search-active"),g=$("#jukebox-container").outerHeight(),a=a?$("#search-container").outerHeight():0;$("#body").css("height",
Math.max(g,a))},200)},onLoadPlaylist:function(b,d){a=playlist.create(d);if(a.isEmpty())f.toggleVideoDisplay(!0);else{f.toggleVideoDisplay();$("tbody").remove();var g=c.createTracklist(a.videos(),"normal-tracklist"),p=c.createTracklist(a.shuffledVideos(),"shuffled-tracklist");$("#video-table").append(g,p);f.loadVideo();f.toggleTracklist(!0);f.toggleShuffle(!0);$("#video-settings").fadeIn()}f.updateNowPlaying(b)}},f={loadVideo:function(b,c){if($("#video-src").attr("src")&&bchanx.player.hasOwnProperty("playVideo"))bchanx.player.loadVideoById(b||
a.getMediaId());else{var g=playlist.getUrl(b,c)||a.getUrl();console.log("--\x3e> SRC: "+g);$("#video-src").attr("src",g).css("visibility","visible")}},loadPlaylist:function(a){d.slide("video");setTimeout(function(){if(e[a])return l.onLoadPlaylist(a,e[a]);$.ajax({url:"/jukebox/playlistLoad",type:"POST",data:{pid:a},dataType:"json",success:function(a){e[a.pid]=a.data;l.onLoadPlaylist(a.pid,a.data)}})},600)},toggleVideoDisplay:function(a){a?(bchanx.player.hasOwnProperty("stopVideo")&&bchanx.player.stopVideo(),
$(".playlist-playing").removeClass("playlist-playing"),$("#video-src").hide(),$("#video-settings").hide(),$("#video-src-none").css("visibility","visible")):($("#video-src-none").css("visibility","hidden"),$("#video-src").show())},updateNowPlaying:function(b,c,g){a&&!a.isEmpty()&&($(".playing").removeClass("playing"),$('tr[mediaid="'+a.getId()+'"]').addClass("playing"),c=c||a.getTitle(),g=g||a.getDuration(),$("#video-title").attr("title",c).text(c),$("#video-length").text(m.formatTime(g)));b&&($(".playlist-playing").removeClass("playlist-playing"),
$('li[pid="'+b+'"]').addClass("playlist-playing"))},toggleShuffle:function(b){if(a){b||a.toggleShuffle();b=a.isShuffled();$("#shuffle").removeClass(b?"off":"on").addClass(b?"on":"off");var c="tbody."+(b?"shuffled":"normal")+"-tracklist";$("tbody."+(b?"normal":"shuffled")+"-tracklist").css("opacity",0).hide();$(c).show().animate({opacity:1},400)}},toggleTracklist:function(a){a||$("#playlist").hasClass("hide")?($("#playlist").removeClass("hide").addClass("show"),$("#video-playlist").hide(),$("#video-playing-info").fadeIn()):
($("#playlist").removeClass("show").addClass("hide"),$("#video-playing-info").hide(),$("#video-playlist").fadeIn())}};b.static();b.dynamic();$.ajax({url:"/jukebox/playlistGetAll",type:"GET",dataType:"json",success:l.onPlaylistGetAll});return{play:function(a,b,g){f.toggleVideoDisplay();f.loadVideo(a,playlist.type.YOUTUBE);d.slide("video");f.updateNowPlaying(null,b,g)}}},Search=function(d){var a={},e=/^PT(\d+H)?(\d+M)?(\d+S)?$/i,m=null,c=!1,b={escape:function(a){return $("<div>").text(a).html()},formatDigit:function(a){a=
String(parseInt(a||0,10));return 1==a.length?"0"+a:a},formatTime:function(a){a=e.exec(a);for(var c=[],k=1;4!=k;k++)c.push(b.formatDigit(a[k]));return c.join(":")},getPx:function(a){return parseInt(a.slice(0,a.length-2),10)},lineclamp:function(a,c){var k=b.getPx($(a).css("line-height"))*c,d=$(a).css("color"),f=$(a).text(),e=f.split(" ");if(b.getPx($(a).css("height"))>k)for($(a).attr("title",f),e.push("..."),$(a).css("color","transparent");b.getPx($(a).css("height"))>k&&!(2>=e.length);)e=e.splice(0,
e.length-2),e.push("..."),$(a).text(e.join(" "));2>=e.length&&($(a).attr("title",f),$(a).text(e.join(" ")).css({"text-overflow":"ellipsis",overflow:"hidden","white-space":"nowrap"}));$(a).css({height:k,color:d})}},l={result:function(a){return'<div class="search-result" data-id="'+b.escape(a.id)+'"><div class="actions"><div class="addto">+</div></div><div class="title">'+b.escape(a.snippet.title)+'</div><div class="thumbnail"><img src="'+a.snippet.thumbnails.default.url+'"/><div class="length">'+b.escape(b.formatTime(a.contentDetails.duration))+
"</div></div></div>"},nav:function(a,c,d){a=void 0!=a?'<div class="search-nav-button prev" data-token="'+b.escape(a)+'">prev</div>':"";c=void 0!==c?'<div class="search-nav-button next" data-token="'+b.escape(c)+'">next</div>':"";return'<div class="search-nav" data-token="'+d+'">'+a+c+"</div>"}},f={hit:function(b,c){return b&&a[b]&&a[b][c]},get:function(b,c){return a[b][c]},set:function(b,c,d){a[b]||(a[b]={});return a[b][c]=d}},h={static:function(){$("#search-box").bind("paste keyup",function(){var a=
$(this).val();clearInterval(m);m=setTimeout(function(){n.search(a,"")},300)});$("#search-icon").bind("click",function(){$("#jukebox-container").hasClass("search-active")?$("#jukebox-container").removeClass("search-active"):($("#jukebox-container").addClass("search-active"),$("#search-box").focus())})},dynamic:function(){$(document).on("click",".search-nav-button",function(){var a=$("#search-box").val(),b=$(this).attr("data-token");a&&n.search(a,b)});$(document).on("click",".search-result",function(){var a=
$(this).attr("data-id"),b=$(this).children(".title").text(),c=$(this).children(".thumbnail").children(".length").text();d.play(a,b,c)});if("devel"===bchanx.type)$(document).on("click",".actions .addto",function(a){a.stopPropagation();a=$(this).parents(".search-result").attr("data-id");var b=$("li[pid].playlist-playing").attr("pid")||2,c=$("#jukebox-key").text();$.ajax({url:"/jukebox/playlistAddMedia?pid="+b+"&media-url="+encodeURIComponent("http://www.youtube.com/watch?v="+a)+"&key="+c,type:"GET",
success:function(a){console.log(a)}})})}},n={search:function(a,d){c||(c=!0,$(".search-results").addClass("disabled"),n.request(a,d,function(a){$(".search-results").children().remove();if(a.length){for(var d in a)$(".search-results").append($(a[d]));$.each($(".search-result .title"),function(){b.lineclamp($(this),3)})}c=!1;$(".search-results").removeClass("disabled")}))},request:function(a,b,c){if(f.hit(a,b))c(f.get(a,b));else if(a&&a.length&&gapi.client.youtube){var d=gapi.client.youtube.search.list({maxResults:5,
pageToken:b,part:"snippet",q:a,type:"video"});d.execute(function(e){if(e.items&&e.items.length){var h=[],m=$(".search-nav").length?$(".search-nav").attr("data-token"):void 0,n=e.nextPageToken,q;for(q in e.items)h.push(e.items[q].id.videoId);d=gapi.client.youtube.videos.list({part:"contentDetails, snippet",id:h.join(", ")});d.execute(function(d){var e=[],h;for(h in d.items)e.push(l.result(d.items[h]));e.push(l.nav(m,n,b));c(f.set(a,b,e))})}else c(f.set(a,b,[]))})}else c([])}};h.static();h.dynamic()};
$(function(){var d=new Jukebox;new Search(d);var d=["#playlist-create"],a;for(a in d)$(d[a]).length&&$(d[a]).bind("submit",function(a){a.preventDefault();$.ajax({url:this.action,data:$(this).serialize(),type:"POST",dataType:"json",success:function(a){$('input[type="text"]').val("")}})})});
