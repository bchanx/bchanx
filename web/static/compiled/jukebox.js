var bchanx=bchanx||{},Playlist=function(a,g,e){var b=this;b.TYPE={UNKNOWN:-1,YOUTUBE:0};b.player="#"+a;b.videos=g||[];b.idToVideo={};for(a=0;a<b.videos.length;a++)b.idToVideo[b.videos[a].id]=b.videos[a];b.shuffledVideos=function(){for(var c=b.videos.slice(0),a=c.length-1;0<a;a--){var f=Math.floor(Math.random()*(a+1)),n=c[a];c[a]=c[f];c[f]=n}return c}();b.isShuffled=!!e;b.isRepeat=!1;b.currentList=function(){return b.isShuffled?b.shuffledVideos:b.videos};b.current=b.currentList()[0];b.getResource=
function(a,d){return a&&d==b.TYPE.YOUTUBE?"https://www.youtube.com/embed/"+a+"?rel=0&enablejsapi=1&iv_load_policy=3&showinfo=0&theme=light":""};b.getUrl=function(){return b.current?b.getResource(b.current.meta.mediaId,b.current.meta.mediaType):""};b.getId=function(){return b.current?b.current.id:""};b.getMediaId=function(){return b.current?b.current.meta.mediaId:""};b.toggleShuffle=function(){b.isShuffled=!b.isShuffled};b.toggleRepeat=function(){b.isRepeat=!b.isRepeat};b.prev=function(){var a=b.currentList();
if(0<=a.indexOf(b.current)){var d=(a.indexOf(b.current)+a.length-1)%a.length;b.current=a[d]}return b.getMediaId()};b.next=function(){var a=b.currentList();if(0<=a.indexOf(b.current)){var d=(a.indexOf(b.current)+1)%a.length;b.current=a[d]}return b.getMediaId()};b.isEmpty=function(){return!b.current};b.setCurrent=function(a){return a in b.idToVideo?(b.current=b.idToVideo[a],!0):!1}};bchanx.player={};
function onYouTubeIframeAPIReady(){bchanx.player=new YT.Player("video-src",{events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange}})}function onPlayerReady(a){a.target.setVolume(100);a.target.playVideo()}function onPlayerStateChange(a){a.data==YT.PlayerState.PLAYING?($("#play").hide(),$("#pause").css("display","inline-block")):a.data==YT.PlayerState.PAUSED?($("#pause").hide(),$("#play").css("display","inline-block")):a.data==YT.PlayerState.ENDED&&$("#next").trigger("click",[!0])}
var Jukebox=function(){var a=this;a.slidr=null;a.playlist=null;a.playlistData={};var g=function(a){return Math.floor(a/60)+":"+("0"+a%60).slice(-2)},e=function(){$("#pause").bind("click",function(){a.playlist&&!a.playlist.isEmpty()&&bchanx.player.hasOwnProperty("pauseVideo")&&bchanx.player.pauseVideo()});$("#play").bind("click",function(){a.playlist&&!a.playlist.isEmpty()&&bchanx.player.hasOwnProperty("playVideo")&&bchanx.player.playVideo()});$("#prev").bind("click",function(){a.playlist&&!a.playlist.isEmpty()&&
bchanx.player.hasOwnProperty("loadVideoById")&&(bchanx.player.loadVideoById(a.playlist.prev()),a.updateNowPlaying())});$("#next").bind("click",function(c,b){a.playlist&&!a.playlist.isEmpty()&&(b&&a.playlist.isRepeat?bchanx.player.seekTo(0):bchanx.player.hasOwnProperty("loadVideoById")&&(bchanx.player.loadVideoById(a.playlist.next()),a.updateNowPlaying()))});$("#repeat").bind("click",function(){if(a.playlist&&!a.playlist.isEmpty()){a.playlist.toggleRepeat();var c=a.playlist.isRepeat;$("#repeat").removeClass(c?
"off":"on").addClass(c?"on":"off")}});$("#shuffle").bind("click",function(){a.playlist&&!a.playlist.isEmpty()&&a.toggleShuffle()});$("#playlist").bind("click",function(){a.playlist&&!a.playlist.isEmpty()&&a.toggleTracklist()})},b=function(){$(document).on("click",".mediaItem",function(){a.playlist&&!a.playlist.isEmpty()&&a.playlist.setCurrent($(this).attr("mediaid"))&&(bchanx.player.loadVideoById(a.playlist.getMediaId()),a.updateNowPlaying())});$(document).on("click","li[pid]",function(){a.loadPlaylist($(this).attr("pid"))});
$(document).keydown(function(a){78===a.which?$("#next").click():80===a.which?$("#prev").click():83===a.which&&$("#shuffle").click()})};a.init=function(){e();b();$.ajax({url:"/jukebox/playlistGetAll",type:"GET",dataType:"json",success:a.onPlaylistGetAll});return a};a.onPlaylistGetAll=function(c){if(c.length){c=c.sort(function(a,c){return a.pid-c.pid});for(var b=$("<ul></ul>"),f=0;f<c.length;f++)b.append('<li pid="'+c[f].pid+'">'+c[f].title+"</li>");$("#playlists").append(b)}a.slidr=slidr.create("jukebox",
{transition:"cube",overflow:!0,controls:"none",keyboard:!0}).add("h",["playlists","video","about","playlists"]).add("v",["playlists","video","about","playlists"]).start();$("#search-container").fadeIn(400);setInterval(function(){var a=$("#jukebox-container").hasClass("search-active"),c=$("#jukebox-container").outerHeight(),a=a?$("#search-container").outerHeight():0;$("#body").css("height",Math.max(c,a))},200)};a.loadPlaylist=function(c){a.slidr.slide("right");setTimeout(function(){if(a.playlistData[c])return a.onLoadPlaylist(c,
a.playlistData[c]);$.ajax({url:"/jukebox/playlistLoad",type:"POST",data:{pid:c},dataType:"json",success:function(c){a.playlistData[c.pid]=c.data;a.onLoadPlaylist(c.pid,c.data)}})},600)};a.onLoadPlaylist=function(c,b){a.playlist=new Playlist("video-src",b,!0);if(a.playlist.isEmpty())a.toggleVideoDisplay(!0);else{a.toggleVideoDisplay();$("tbody").remove();var f=a.createTracklist(a.playlist.videos,"normal-tracklist"),e=a.createTracklist(a.playlist.shuffledVideos,"shuffled-tracklist");$("#video-table").append(f,
e);$("#video-src").attr("src")&&bchanx.player.hasOwnProperty("playVideo")?bchanx.player.loadVideoById(a.playlist.getMediaId()):$("#video-src").attr("src",a.playlist.getUrl()).css("visibility","visible");a.toggleTracklist(!0);a.toggleShuffle(!0);$("#video-settings").fadeIn()}a.updateNowPlaying(c)};a.toggleVideoDisplay=function(a){a?(bchanx.player.hasOwnProperty("stopVideo")&&bchanx.player.stopVideo(),$(".playlist-playing").removeClass("playlist-playing"),$("#video-src").hide(),$("#video-settings").hide(),
$("#video-src-none").css("visibility","visible")):($("#video-src-none").css("visibility","hidden"),$("#video-src").show())};a.updateNowPlaying=function(c){if(a.playlist&&!a.playlist.isEmpty()){$(".playing").removeClass("playing");$('tr[mediaid="'+a.playlist.getId()+'"]').addClass("playing");var b=a.playlist.current.meta.title,f=a.playlist.current.meta.duration;$("#video-title").attr("title",b).text(b);$("#video-length").text(g(f))}c&&($(".playlist-playing").removeClass("playlist-playing"),$('li[pid="'+
c+'"]').addClass("playlist-playing"))};a.toggleShuffle=function(c){if(a.playlist){c||a.playlist.toggleShuffle();c=a.playlist.isShuffled;$("#shuffle").removeClass(c?"off":"on").addClass(c?"on":"off");var b="tbody."+(c?"shuffled":"normal")+"-tracklist";$("tbody."+(c?"normal":"shuffled")+"-tracklist").css("opacity",0).hide();$(b).show().animate({opacity:1},400)}};a.toggleTracklist=function(a){a||$("#playlist").hasClass("hide")?($("#playlist").removeClass("hide").addClass("show"),$("#video-playlist").hide(),
$("#video-playing-info").fadeIn()):($("#playlist").removeClass("show").addClass("hide"),$("#video-playing-info").hide(),$("#video-playlist").fadeIn())};a.createTracklist=function(a,b){for(var f=$('<tbody class="'+b+'" style="display: none"></tbody>'),e=0;e<a.length;e++){var h=a[e],k=h.meta.title,l=g(h.meta.duration);f.append('<tr mediaid="'+h.id+'" class="mediaItem"><td class="track" title="'+k+'">'+k+'</td><td class="length">'+l+"</td></tr>")}return f};return a},Search=function(){var a={},g=/^PT(\d+H)?(\d+M)?(\d+S)?$/i,
e={escape:function(a){return $("<div>").text(a).html()},formatDigit:function(a){a=String(parseInt(a||0,10));return 1==a.length?"0"+a:a},formatTime:function(a){a=g.exec(a);for(var b=[],f=1;4!=f;f++)b.push(e.formatDigit(a[f]));return b.join(":")},resultTemplate:function(a){return'<div class="search-result" data-id="'+e.escape(a.id)+'"><div class="actions"><div class="addto">+</div></div><div class="title">'+e.escape(a.snippet.title)+'</div><div class="thumbnail"><img src="'+a.snippet.thumbnails["default"].url+
'"/><div class="length">'+e.escape(e.formatTime(a.contentDetails.duration))+"</div></div></div>"},navTemplate:function(a,b,f){a=void 0!=a?'<div class="search-button prev" data-token="'+e.escape(a)+'">prev</div>':"";b=void 0!==b?'<div class="search-button next" data-token="'+e.escape(b)+'">next</div>':"";return'<div class="search-nav" data-token="'+f+'">'+a+b+"</div>"}},b={hit:function(b,d){return b&&a[b]&&a[b][d]},get:function(b,d){return a[b][d]},set:function(b,d,f){a[b]||(a[b]={});return a[b][d]=
f}};return{search:function(a,d,f){if(b.hit(a,d))f(b.get(a,d));else if(a&&a.length&&gapi.client.youtube){var g=gapi.client.youtube.search.list({maxResults:5,pageToken:d,part:"snippet",q:a,type:"video"});g.execute(function(h){if(h.items&&h.items.length){var k=[],l=$(".search-nav").length?$(".search-nav").attr("data-token"):void 0,p=h.nextPageToken,m;for(m in h.items)k.push(h.items[m].id.videoId);g=gapi.client.youtube.videos.list({part:"contentDetails, snippet",id:k.join(", ")});g.execute(function(g){var h=
[],k;for(k in g.items)h.push(e.resultTemplate(g.items[k]));h.push(e.navTemplate(l,p,d));f(b.set(a,d,h))})}else f(b.set(a,d,[]))})}else f([])}}};googleApiClientReady=function(){gapi.client.setApiKey(bchanx.googleApiKey);gapi.client.load("youtube","v3")};
var GETPX=function(a){return parseInt(a.slice(0,a.length-2),10)},LINECLAMP=function(a,g){var e=GETPX($(a).css("line-height"))*g,b=$(a).css("color"),c=$(a).text(),d=c.split(" ");if(GETPX($(a).css("height"))>e)for($(a).attr("title",c),d.push("..."),$(a).css("color","transparent");GETPX($(a).css("height"))>e&&!(2>=d.length);)d=d.splice(0,d.length-2),d.push("..."),$(a).text(d.join(" "));2>=d.length&&($(a).attr("title",c),$(a).text(d.join(" ")).css({"text-overflow":"ellipsis",overflow:"hidden","white-space":"nowrap"}));
$(a).css({height:e,color:b})};
$(function(){(new Jukebox).init();var a=new Search,g,e=!1,b=function(b,c){e||(e=!0,$(".search-results").addClass("disabled"),a.search(b,c,function(a){$(".search-results").children().remove();if(a.length){for(var b in a)$(".search-results").append($(a[b]));$.each($(".search-result .title"),function(){LINECLAMP($(this),3)})}e=!1;$(".search-results").removeClass("disabled")}))};$("#search-box").bind("paste keyup",function(){var a=$(this).val();clearInterval(g);g=setTimeout(function(){b(a,"")},300)});
$(document).on("click",".search-button",function(){var a=$("#search-box").val(),c=$(this).attr("data-token");a&&b(a,c)});$("#search-icon").bind("click",function(){$("#jukebox-container").hasClass("search-active")?$("#jukebox-container").removeClass("search-active"):$("#jukebox-container").addClass("search-active")});$(document).on("click",".search-result",function(){var a=$(this).attr("data-id");console.log(a)});var c=["#playlist-create"],d;for(d in c)$(c[d]).length&&$(c[d]).bind("submit",function(a){a.preventDefault();
$.ajax({url:this.action,data:$(this).serialize(),type:"POST",dataType:"json",success:function(a){$('input[type="text"]').val("")}})})});
