/*!
 * Copyright (c) 2014 Brian Chan (bchanx.com)
 * All Rights Reserved.
 */

var bchanx=bchanx||{};(function(c,a){c.playlist=a()})(this,function(){var c={UNKNOWN:-1,YOUTUBE:0};return{TYPE:c,getResource:function(a,e){return a&&e==c.YOUTUBE?"https://www.youtube.com/embed/"+a+"?rel=0&enablejsapi=1&iv_load_policy=3&showinfo=0&theme=light":""}}});
var Playlist=function(c,a,e){var b=this;b.TYPE={UNKNOWN:-1,YOUTUBE:0};b.player="#"+c;b.videos=a||[];b.idToVideo={};for(c=0;c<b.videos.length;c++)b.idToVideo[b.videos[c].id]=b.videos[c];b.shuffledVideos=function(){for(var a=b.videos.slice(0),c=a.length-1;0<c;c--){var e=Math.floor(Math.random()*(c+1)),d=a[c];a[c]=a[e];a[e]=d}return a}();b.isShuffled=!!e;b.isRepeat=!1;b.currentList=function(){return b.isShuffled?b.shuffledVideos:b.videos};b.current=b.currentList()[0];b.getResource=function(a,c){return a&&
c==b.TYPE.YOUTUBE?"https://www.youtube.com/embed/"+a+"?rel=0&enablejsapi=1&iv_load_policy=3&showinfo=0&theme=light":""};b.getUrl=function(){return b.current?b.getResource(b.current.meta.mediaId,b.current.meta.mediaType):""};b.getId=function(){return b.current?b.current.id:""};b.getMediaId=function(){return b.current?b.current.meta.mediaId:""};b.toggleShuffle=function(){b.isShuffled=!b.isShuffled};b.toggleRepeat=function(){b.isRepeat=!b.isRepeat};b.prev=function(){var a=b.currentList();if(0<=a.indexOf(b.current)){var c=
(a.indexOf(b.current)+a.length-1)%a.length;b.current=a[c]}return b.getMediaId()};b.next=function(){var a=b.currentList();if(0<=a.indexOf(b.current)){var c=(a.indexOf(b.current)+1)%a.length;b.current=a[c]}return b.getMediaId()};b.isEmpty=function(){return!b.current};b.setCurrent=function(a){return a in b.idToVideo?(b.current=b.idToVideo[a],!0):!1}};bchanx.player={};
function onYouTubeIframeAPIReady(){bchanx.player=new YT.Player("video-src",{events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange}})}function onPlayerReady(c){c.target.setVolume(100);c.target.playVideo()}function onPlayerStateChange(c){c.data==YT.PlayerState.PLAYING?($("#play").hide(),$("#pause").css("display","inline-block")):c.data==YT.PlayerState.PAUSED?($("#pause").hide(),$("#play").css("display","inline-block")):c.data==YT.PlayerState.ENDED&&$("#next").trigger("click",[!0])}
function googleApiClientReady(){gapi.client.setApiKey(bchanx.googleApiKey);gapi.client.load("youtube","v3")}
var Jukebox=function(){var c=null,a=null,e={},b={formatTime:function(a){return 0<a.indexOf(":")?a:Math.floor(a/60)+":"+("0"+a%60).slice(-2)},jq:function(a){return"#"+a.replace(/(:|\.|\[|\])/g,"\\$1")}},k={createTracklist:function(a,c){for(var g=$('<tbody class="'+c+'" style="display: none"></tbody>'),p=0;p<a.length;p++){var q=a[p],d=q.meta.title,e=b.formatTime(q.meta.duration);g.append('<tr mediaid="'+q.id+'" class="mediaItem"><td class="track" title="'+d+'">'+d+'</td><td class="length">'+e+"</td></tr>")}return g}},
f={"static":function(){$("#pause").bind("click",function(){a&&!a.isEmpty()&&bchanx.player.hasOwnProperty("pauseVideo")&&bchanx.player.pauseVideo()});$("#play").bind("click",function(){a&&!a.isEmpty()&&bchanx.player.hasOwnProperty("playVideo")&&bchanx.player.playVideo()});$("#prev").bind("click",function(){a&&!a.isEmpty()&&bchanx.player.hasOwnProperty("loadVideoById")&&(bchanx.player.loadVideoById(a.prev()),d.updateNowPlaying())});$("#next").bind("click",function(b,c){a&&!a.isEmpty()&&(c&&a.isRepeat?
bchanx.player.seekTo(0):bchanx.player.hasOwnProperty("loadVideoById")&&(bchanx.player.loadVideoById(a.next()),d.updateNowPlaying()))});$("#repeat").bind("click",function(){if(a&&!a.isEmpty()){a.toggleRepeat();var b=a.isRepeat;$("#repeat").removeClass(b?"off":"on").addClass(b?"on":"off")}});$("#shuffle").bind("click",function(){a&&!a.isEmpty()&&d.toggleShuffle()});$("#playlist").bind("click",function(){a&&!a.isEmpty()&&d.toggleTracklist()})},dynamic:function(){$(document).on("click",".mediaItem",function(){a&&
!a.isEmpty()&&a.setCurrent($(this).attr("mediaid"))&&(bchanx.player.loadVideoById(a.getMediaId()),d.updateNowPlaying())});$(document).on("click","li[pid]",function(){d.loadPlaylist($(this).attr("pid"))});$(document).keydown(function(a){"search-box"!==$(a.target).attr("id")&&(78===a.which?$("#next").click():80===a.which?$("#prev").click():83===a.which&&$("#shuffle").click())})}},l={onPlaylistGetAll:function(a){if(a.length){a=a.sort(function(a,g){return a.pid-g.pid});for(var b=$("<ul></ul>"),g=0;g<
a.length;g++)b.append('<li pid="'+a[g].pid+'">'+a[g].title+"</li>");$("#playlists").append(b)}c=slidr.create("jukebox",{transition:"cube",overflow:!0,controls:"none",keyboard:!0}).add("h",["playlists","video","about","playlists"]).add("v",["playlists","video","about","playlists"]).start();$("#search-container").fadeIn(400);setInterval(function(){var a=$("#jukebox-container").hasClass("search-active"),g=$("#jukebox-container").outerHeight(),a=a?$("#search-container").outerHeight():0;$("#body").css("height",
Math.max(g,a))},200)},onLoadPlaylist:function(b,c){a=new Playlist("video-src",c,!0);if(a.isEmpty())d.toggleVideoDisplay(!0);else{d.toggleVideoDisplay();$("tbody").remove();var g=k.createTracklist(a.videos,"normal-tracklist"),p=k.createTracklist(a.shuffledVideos,"shuffled-tracklist");$("#video-table").append(g,p);d.loadVideo();d.toggleTracklist(!0);d.toggleShuffle(!0);$("#video-settings").fadeIn()}d.updateNowPlaying(b)}},d={loadVideo:function(b,c){if($("#video-src").attr("src")&&bchanx.player.hasOwnProperty("playVideo"))bchanx.player.loadVideoById(b||
a.getMediaId());else{var g=void 0!=b&&void 0!=c?playlist.getResource(b,c):a.getUrl();$("#video-src").attr("src",g).css("visibility","visible")}},loadPlaylist:function(a){c.slide("video");setTimeout(function(){if(e[a])return l.onLoadPlaylist(a,e[a]);$.ajax({url:"/jukebox/playlistLoad",type:"POST",data:{pid:a},dataType:"json",success:function(a){e[a.pid]=a.data;l.onLoadPlaylist(a.pid,a.data)}})},600)},toggleVideoDisplay:function(a){a?(bchanx.player.hasOwnProperty("stopVideo")&&bchanx.player.stopVideo(),
$(".playlist-playing").removeClass("playlist-playing"),$("#video-src").hide(),$("#video-settings").hide(),$("#video-src-none").css("visibility","visible")):($("#video-src-none").css("visibility","hidden"),$("#video-src").show())},updateNowPlaying:function(c,d,g){a&&!a.isEmpty()&&($(".playing").removeClass("playing"),$('tr[mediaid="'+a.getId()+'"]').addClass("playing"),d=d||a.current.meta.title,g=g||a.current.meta.duration,$("#video-title").attr("title",d).text(d),$("#video-length").text(b.formatTime(g)));
c&&($(".playlist-playing").removeClass("playlist-playing"),$('li[pid="'+c+'"]').addClass("playlist-playing"))},toggleShuffle:function(b){if(a){b||a.toggleShuffle();b=a.isShuffled;$("#shuffle").removeClass(b?"off":"on").addClass(b?"on":"off");var c="tbody."+(b?"shuffled":"normal")+"-tracklist";$("tbody."+(b?"normal":"shuffled")+"-tracklist").css("opacity",0).hide();$(c).show().animate({opacity:1},400)}},toggleTracklist:function(a){a||$("#playlist").hasClass("hide")?($("#playlist").removeClass("hide").addClass("show"),
$("#video-playlist").hide(),$("#video-playing-info").fadeIn()):($("#playlist").removeClass("show").addClass("hide"),$("#video-playing-info").hide(),$("#video-playlist").fadeIn())}};f["static"]();f.dynamic();$.ajax({url:"/jukebox/playlistGetAll",type:"GET",dataType:"json",success:l.onPlaylistGetAll});return{play:function(a,b,g){d.toggleVideoDisplay();d.loadVideo(a,playlist.TYPE.YOUTUBE);c.slide("video");d.updateNowPlaying(null,b,g)}}},Search=function(c){var a={},e=/^PT(\d+H)?(\d+M)?(\d+S)?$/i,b=null,
k=!1,f={escape:function(a){return $("<div>").text(a).html()},formatDigit:function(a){a=String(parseInt(a||0,10));return 1==a.length?"0"+a:a},formatTime:function(a){a=e.exec(a);for(var b=[],c=1;4!=c;c++)b.push(f.formatDigit(a[c]));return b.join(":")},getPx:function(a){return parseInt(a.slice(0,a.length-2),10)},lineclamp:function(a,b){var c=f.getPx($(a).css("line-height"))*b,d=$(a).css("color"),e=$(a).text(),h=e.split(" ");if(f.getPx($(a).css("height"))>c)for($(a).attr("title",e),h.push("..."),$(a).css("color",
"transparent");f.getPx($(a).css("height"))>c&&!(2>=h.length);)h=h.splice(0,h.length-2),h.push("..."),$(a).text(h.join(" "));2>=h.length&&($(a).attr("title",e),$(a).text(h.join(" ")).css({"text-overflow":"ellipsis",overflow:"hidden","white-space":"nowrap"}));$(a).css({height:c,color:d})}},l={result:function(a){return'<div class="search-result" data-id="'+f.escape(a.id)+'"><div class="actions"><div class="addto">+</div></div><div class="title">'+f.escape(a.snippet.title)+'</div><div class="thumbnail"><img src="'+
a.snippet.thumbnails["default"].url+'"/><div class="length">'+f.escape(f.formatTime(a.contentDetails.duration))+"</div></div></div>"},nav:function(a,b,c){a=void 0!=a?'<div class="search-nav-button prev" data-token="'+f.escape(a)+'">prev</div>':"";b=void 0!==b?'<div class="search-nav-button next" data-token="'+f.escape(b)+'">next</div>':"";return'<div class="search-nav" data-token="'+c+'">'+a+b+"</div>"}},d={hit:function(b,c){return b&&a[b]&&a[b][c]},get:function(b,c){return a[b][c]},set:function(b,
c,d){a[b]||(a[b]={});return a[b][c]=d}},m={"static":function(){$("#search-box").bind("paste keyup",function(){var a=$(this).val();clearInterval(b);b=setTimeout(function(){n.search(a,"")},300)});$("#search-icon").bind("click",function(){$("#jukebox-container").hasClass("search-active")?$("#jukebox-container").removeClass("search-active"):($("#jukebox-container").addClass("search-active"),$("#search-box").focus())})},dynamic:function(){$(document).on("click",".search-nav-button",function(){var a=$("#search-box").val(),
b=$(this).attr("data-token");a&&n.search(a,b)});$(document).on("click",".search-result",function(){var a=$(this).attr("data-id"),b=$(this).children(".title").text(),d=$(this).children(".thumbnail").children(".length").text();console.log(a);c.play(a,b,d)})}},n={search:function(a,b){k||(k=!0,$(".search-results").addClass("disabled"),n.request(a,b,function(a){$(".search-results").children().remove();if(a.length){for(var b in a)$(".search-results").append($(a[b]));$.each($(".search-result .title"),function(){f.lineclamp($(this),
3)})}k=!1;$(".search-results").removeClass("disabled")}))},request:function(a,b,c){if(d.hit(a,b))c(d.get(a,b));else if(a&&a.length&&gapi.client.youtube){var e=gapi.client.youtube.search.list({maxResults:5,pageToken:b,part:"snippet",q:a,type:"video"});e.execute(function(f){if(f.items&&f.items.length){var h=[],k=$(".search-nav").length?$(".search-nav").attr("data-token"):void 0,n=f.nextPageToken,m;for(m in f.items)h.push(f.items[m].id.videoId);e=gapi.client.youtube.videos.list({part:"contentDetails, snippet",
id:h.join(", ")});e.execute(function(e){var f=[],h;for(h in e.items)f.push(l.result(e.items[h]));f.push(l.nav(k,n,b));c(d.set(a,b,f))})}else c(d.set(a,b,[]))})}else c([])}};m["static"]();m.dynamic()};$(function(){var c=new Jukebox;new Search(c);var c=["#playlist-create"],a;for(a in c)$(c[a]).length&&$(c[a]).bind("submit",function(a){a.preventDefault();$.ajax({url:this.action,data:$(this).serialize(),type:"POST",dataType:"json",success:function(a){$('input[type="text"]').val("")}})})});
